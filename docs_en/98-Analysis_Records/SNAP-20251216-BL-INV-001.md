# SNAP-20251216-BL-INV-001
**Title:** Financial Logic Integrity & Lifecycle Mismatch  
**Snapshot ID:** SNAP-20251216-BL-INV-001  
**Scope:** Invoicing Module — Balance update fragmentation between `InvoiceController::store` and `InvoiceObserver::created`.  
**Status:** REQUIRES DECISION  
**Author:** Automated Snapshot Registration  
**Date:** 2025-12-16

---

## Context
Architectural review comparing:
- Docs: `BR_Catalogue.md` (Invoice lifecycle / balance rules)
- Code: `InvoiceController.php`, `InvoiceObserver.php`

This Snapshot records an analysis finding; it is **non-normative**.

---

## Findings Summary
- **Finding BL-INV-01**: Balance Logic Fragmentation — the code updates customer balances in `InvoiceController::store` after FIFO allocation; `InvoiceObserver::created` intentionally skips balance updates.

---

## Risk Surface
- **Integrity Risk (Medium-High)**: Invoices created outside the controller flow may not update customer balances — "Ghost Invoices".
- **Maintenance Risk**: Future contributors relying on Observer-driven invariants may introduce silent corruption.
- **Audit Risk**: Potential mismatch between sub-ledger and customer balances.

---

## Assumptions in Question
- Atomic Model Integrity is broken.
- Single Source of Truth is broken.
- Controller is not a thin layer as documented.

---

## Open Questions
1. Is the controller dependency deliberate (performance / transactional reasons)?
2. Are importers / seeders / background jobs using `Invoice::create()` today?
3. Do tests verify ledger consistency across all write paths?

---

## Recommended Usage (Reference only)
- Cite in ADRs, Refactor plans, Audit prep, and any Import/Export feature design.
- **Do not** use as authoritative API or business-rule doc.

---

## Metadata
- `snapshot_id`: SNAP-20251216-BL-INV-001  
- `related_modules`: ["Invoices","Customers","Accounting Core"]  
- `analysis_type`: "Architecture & Accounting Integrity"  
- `decision_made`: false  
- `validity`: "Until decision or refactor occurs"

---

## Forward Guidance (non-normative)
Keep this Snapshot active until the team either:
- Refactors to enforce balance updates at model/service level, or
- Formally documents and accepts the controller-centric pattern.
