# Process Flows - تدفقات العمليات

## 📋 نظرة عامة

هذا الملف يوثق **التدفقات الرئيسية** للعمليات في النظام.

---

## 🛒 Flow 1: عملية البيع الكاملة

```
┌─────────────────────────────────────────────────────────────────┐
│                         عملية البيع                              │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────┐
       │   الكاشير    │
       └──────┬──────┘
              │
              ▼
    ┌─────────────────────┐
    │  اختيار العميل      │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  إضافة الأصناف      │◄─────────────────────┐
    │  (المنتج + الكمية)  │                      │
    └──────────┬──────────┘                      │
              │                                  │
              ▼                                  │
    ┌─────────────────────┐                      │
    │  FIFO Check         │                      │
    │  هل الكمية متوفرة؟  │                      │
    └──────────┬──────────┘                      │
              │                                  │
      ┌───────┴───────┐                          │
      │               │                          │
     ✅              ❌                          │
      │               │                          │
      ▼               ▼                          │
┌──────────┐   ┌──────────────────┐             │
│ أضف للفاتورة│   │ "الكمية غير متوفرة"│             │
└─────┬────┘   └──────────────────┘             │
      │                                          │
      │                                          │
      ▼                                          │
┌─────────────────────┐                          │
│ هل تريد إضافة       │───── نعم ────────────────┘
│ صنف آخر؟            │
└──────────┬──────────┘
          │ لا
          ▼
┌─────────────────────┐
│  تحديد السعر لكل بند │
│  (سعر الوحدة)        │
└──────────┬──────────┘
          │
          ▼
┌─────────────────────┐
│  حساب الإجمالي      │
│  item = وزن × سعر   │
│  subtotal = مجموع   │
│  total = sub - خصم  │
└──────────┬──────────┘
          │
          ▼
┌─────────────────────┐
│     حفظ الفاتورة     │
└──────────┬──────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│           Backend Processing             │
├──────────────────────────────────────────┤
│ 1. توليد invoice_number                 │
│ 2. إنشاء Invoice (balance = total)      │
│ 3. إنشاء InvoiceItems                   │
│ 4. FIFO: خصم من shipment_items          │
│ 5. Observer: customer.balance +=        │
│ 6. Observer: ShipmentItem (auto-close?) │
│ 7. Audit Log                            │
└──────────┬──────────────────────────────┘
          │
          ▼
┌─────────────────────┐
│   طباعة الفاتورة    │
└─────────────────────┘
```

---

## 💰 Flow 2: عملية التحصيل

```
┌─────────────────────────────────────────────────────────────────┐
│                        عملية التحصيل                             │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────┐
       │   الكاشير    │
       └──────┬──────┘
              │
              ▼
    ┌─────────────────────┐
    │  اختيار العميل      │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  عرض رصيد العميل    │
    │  + الفواتير المفتوحة │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  إدخال المبلغ المحصل │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  طريقة الدفع        │
    │  (نقدي / بنك)       │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  طريقة التوزيع      │
    │  (FIFO / يدوي)      │
    └──────────┬──────────┘
              │
      ┌───────┴───────┐
      │               │
    FIFO           يدوي
      │               │
      ▼               ▼
┌──────────────┐ ┌──────────────┐
│ توزيع تلقائي │ │ اختيار فاتورة │
│ على الأقدم   │ │ محددة         │
└──────┬───────┘ └──────┬───────┘
       │                │
       └────────┬───────┘
                │
                ▼
    ┌─────────────────────┐
    │     حفظ التحصيل      │
    └──────────┬──────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│           Backend Processing             │
├──────────────────────────────────────────┤
│ 1. توليد receipt_number                 │
│ 2. إنشاء Collection                     │
│ 3. Observer: customer.balance -=        │
│ 4. CollectionService: FIFO allocation   │
│ 5. CREATE CollectionAllocations         │
│ 6. Observer: invoice.paid_amount +=     │
│ 7. Observer: invoice.balance -=         │
│ 8. Audit Log                            │
│ 9. إذا cash: Cashbox transaction        │
│ 10. إذا bank: Bank transaction          │
└──────────┬──────────────────────────────┘
                │
                ▼
    ┌─────────────────────┐
    │   طباعة الإيصال     │
    └──────────┬──────────┘
                │
                ▼
    ┌─────────────────────┐
    │ الرصيد الجديد للعميل │
    │ + موجب = مديون      │
    │ 0 = خالص            │
    │ - سالب = دائن       │
    └─────────────────────┘
```

---

## 📦 Flow 3: تصفية الشحنة

```
┌─────────────────────────────────────────────────────────────────┐
│                       تصفية الشحنة                               │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────┐
       │   المسؤول   │
       └──────┬──────┘
              │
              ▼
    ┌─────────────────────┐
    │  اختيار الشحنة      │
    │  (open أو closed)   │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  عرض ملخص الشحنة    │
    │  - الكميات الأصلية  │
    │  - المبيعات         │
    │  - الهالك           │
    │  - المتبقي          │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────────┐
    │  هل يوجد متبقي؟        │
    └───────────┬─────────────┘
                │
        ┌───────┴───────┐
        │               │
       نعم             لا
        │               │
        ▼               │
┌───────────────────┐   │
│ اختيار الشحنة     │   │
│ التالية (مفتوحة)  │   │
└─────────┬─────────┘   │
          │             │
          ▼             │
┌───────────────────┐   │
│  تأكيد الترحيل    │   │
└─────────┬─────────┘   │
          │             │
          └──────┬──────┘
                 │
                 ▼
    ┌─────────────────────┐
    │    تأكيد التصفية     │
    └──────────┬──────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│           Backend Processing             │
├──────────────────────────────────────────┤
│ DB::transaction                          │
│ ├── FOR EACH item WITH remaining > 0:    │
│ │   ├── CREATE ShipmentItem (next)       │
│ │   ├── CREATE Carryover                 │
│ │   ├── UPDATE item.remaining = 0        │
│ │   └── UPDATE item.carryover_out        │
│ ├── UPDATE shipment.status = 'settled'   │
│ └── UPDATE shipment.settled_at = now()   │
└──────────┬──────────────────────────────┘
                │
                ▼
    ┌─────────────────────┐
    │  عرض تقرير التصفية  │
    └──────────┬──────────┘
                │
                ▼
    ┌─────────────────────┐
    │  طباعة / تصدير PDF  │
    └─────────────────────┘
```

---

## 🔙 Flow 4: إلغاء التصفية (Unsettle)

```
┌─────────────────────────────────────────────────────────────────┐
│                     إلغاء التصفية (نادر)                         │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────┐
       │   المسؤول   │
       └──────┬──────┘
              │
              ▼
    ┌─────────────────────┐
    │ اختيار شحنة مُصفاة  │
    │ (status = settled)  │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │ عرض الترحيلات       │
    │ الخارجة من الشحنة   │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────────────────────┐
    │ فحص: هل الكميات المرحلة بيعت؟       │
    └───────────────┬─────────────────────┘
                    │
            ┌───────┴───────┐
            │               │
           نعم             لا
            │               │
            ▼               ▼
    ┌──────────────┐ ┌──────────────────┐
    │   ❌ ممنوع    │ │ ✅ السماح        │
    │ "البضاعة     │ └────────┬─────────┘
    │  اتباعت"     │          │
    └──────────────┘          │
                              ▼
                    ┌─────────────────────┐
                    │    تأكيد الإلغاء     │
                    └──────────┬──────────┘
                              │
                              ▼
┌─────────────────────────────────────────┐
│           Backend Processing             │
├──────────────────────────────────────────┤
│ DB::transaction                          │
│ ├── FOR EACH carryover:                  │
│ │   ├── Safety Check                     │
│ │   ├── fromItem.remaining +=            │
│ │   ├── nextItem.remaining -=            │
│ │   ├── nextItem.initial -=              │
│ │   ├── IF nextItem.initial <= 0: DELETE │
│ │   └── DELETE carryover                 │
│ ├── shipment.status = 'closed'           │
│ └── shipment.settled_at = null           │
└──────────┬──────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │  الشحنة أصبحت closed │
                    │  يمكن التعديل عليها │
                    └─────────────────────┘
```

---

## 📅 Flow 5: التقرير اليومي

```
┌─────────────────────────────────────────────────────────────────┐
│                       التقرير اليومي                             │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────┐
       │   نهاية اليوم│
       └──────┬──────┘
              │
              ▼
    ┌─────────────────────┐
    │  جمع بيانات اليوم   │
    └──────────┬──────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│              المبيعات                    │
├──────────────────────────────────────────┤
│ - إجمالي الفواتير                        │
│ - عدد الفواتير                           │
│ - المبيعات حسب المنتج                    │
│ - المبيعات حسب العميل                    │
└──────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│             التحصيلات                    │
├──────────────────────────────────────────┤
│ - النقدي                                 │
│ - البنك                                  │
│ - الإجمالي                               │
└──────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│             المصروفات                    │
├──────────────────────────────────────────┤
│ - النقدي                                 │
│ - البنك                                  │
│ - حسب النوع (مورد/شركة)                  │
└──────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│            الأرصدة                       │
├──────────────────────────────────────────┤
│ رصيد الخزنة = opening + collections_cash │
│              - expenses_cash             │
│              ± transfers                 │
│                                          │
│ رصيد البنك = opening + collections_bank  │
│             - expenses_bank              │
│             ± transfers                  │
└──────────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │  حفظ التقرير        │
    │  status = 'closed'  │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  تنبيهات AI (إن وجد)│
    │  - سعر شاذ          │
    │  - عملاء متأخرين    │
    │  - شحنات متأخرة     │
    └──────────┬──────────┘
              │
              ▼
    ┌─────────────────────┐
    │  PDF / Excel Export │
    └─────────────────────┘
```

---

## 🔗 الملفات المرتبطة

- [BL_Invoices.md](BL_Invoices.md)
- [BL_Collections.md](BL_Collections.md)
- [BL_Shipments.md](BL_Shipments.md)
- [BL_Inventory_FIFO.md](BL_Inventory_FIFO.md)
