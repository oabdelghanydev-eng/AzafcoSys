# Invoice Business Logic - ููุทู ุงูููุงุชูุฑ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูููู ููุซู **ูู** ุงูุชูุงุตูู ุงููุชุนููุฉ ุจููุทู ุงูููุงุชูุฑ ูู ุงููุธุงู.

---

## ๐ ุฏูุฑุฉ ุญูุงุฉ ุงููุงุชูุฑุฉ (Lifecycle)

```
โโโโโโโโโโโโโโโ
โ   Frontend  โ
โ LocalStorageโ  โ ุงููุณูุฏุงุช ุชูุญูุธ ููุง
โโโโโโโโฌโโโโโโโ
       โ Submit
       โผ
โโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโ
โ   active    โโโโโโบโ  cancelled  โ  
โ  (Default)  โ     โ  (ุฅูุบุงุก)    โ   
โโโโโโโโฌโโโโโโโ     โโโโโโโโโโโโโโโ    
       โ
       โ ุชุญุตููุงุช
       โผ
โโโโโโโโโโโโโโโ
โ balance = 0 โ  โ ูุงุชูุฑุฉ ูุณุฏุฏุฉ ุจุงููุงูู
โ  (ูุณุฏุฏุฉ)    โ
โโโโโโโโโโโโโโโ
```

---

## ๐ Decision Table: ุฅูุดุงุก ูุงุชูุฑุฉ

| ุงูุดุฑุท | ุงููุชูุฌุฉ | ุงูุฅุฌุฑุงุก |
|-------|---------|---------|
| customer_id ููุฌูุฏ | โ | ุงููุชุงุจุนุฉ |
| customer_id ุบูุฑ ููุฌูุฏ | โ | Validation Error |
| items.length > 0 | โ | ุงููุชุงุจุนุฉ |
| items.length = 0 | โ | "ุงููุงุชูุฑุฉ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุจูุฏ ูุงุญุฏ ุนูู ุงูุฃูู" |
| ูู item ูู shipment_item_id | โ | ุงููุชุงุจุนุฉ |
| item ุจุฏูู shipment_item_id | โ | "ูุฌุจ ุชุญุฏูุฏ ูุตุฏุฑ FIFO" |
| remaining_quantity >= quantity | โ | ุงููุชุงุจุนุฉ |
| remaining_quantity < quantity | โ | "ุงููููุฉ ุงููุทููุจุฉ ุบูุฑ ูุชููุฑุฉ" |

---

## ๐งฎ ุงูุญุณุงุจุงุช (Calculations)

### 1. ุญุณุงุจ ุงูุฅุฌูุงูู (โ๏ธ ุชุตุญูุญ 2025-12-13)

```
item_total = total_weight_kg ร price_per_kg
subtotal   = SUM(items.item_total)
discount   = user_input OR 0
total      = subtotal - discount
```

### 1.1 ุฃูุถุงุน ุฅุฏุฎุงู ุงููุฒู (Weight Entry Modes)

> **ููุญุฏุฏ ูู ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ:** `weight_entry_mode`

| ุงููุถุน | ุงููุณุชุฎุฏู ููุฏุฎู | ุงููุธุงู ูุญุณุจ |
|-------|---------------|-------------|
| `total_weight` | ุนุฏุฏ ุงููุญุฏุงุช + ุฅุฌูุงูู ุงููุฒู ุจุงููููู | ูุฒู ุงููุญุฏุฉ = ุฅุฌูุงูู ุงููุฒู รท ุงูุนุฏุฏ |
| `unit_weight` | ุนุฏุฏ ุงููุญุฏุงุช + ูุฒู ุงููุญุฏุฉ ุจุงููููู | ุฅุฌูุงูู ุงููุฒู = ุงูุนุฏุฏ ร ูุฒู ุงููุญุฏุฉ |

**ููุงุญุธุฉ ูุงูุฉ:**
- ุงูุฎุตู ูู ุงูุดุญูุฉ ูููู ุจุนุฏุฏ ุงููุญุฏุงุช (cartons) ูููุณ ุจุงูููููุงุช.
- ูู ุจูุงู ุชุตููุฉ ุงูุดุญูุฉุ ูุธูุฑ **ุนุฌุฒ ุงูููููุงุช**:
  ```
  ุนุฌุฒ ุงููุฒู = ุฅุฌูุงูู ูุฒู ุงูุดุญูุฉ ุงููุงุฑุฏุฉ - ุฅุฌูุงูู ูุฒู ุงููุจูุนุงุช
  ```

### 2. ุญุณุงุจ ุงูุฑุตูุฏ

```
balance = total - paid_amount

ุญูุซ:
- paid_amount = SUM(collection_allocations.amount)
- ูุจุฏุฃ ูู 0 ุนูุฏ ุงูุฅูุดุงุก
```

### 3. ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู

```
ุนูุฏ ุงูุฅูุดุงุก:
  customer.balance += invoice.total

ุนูุฏ ุงูุชุนุฏูู (total ุชุบูุฑ):
  diff = new_total - old_total
  customer.balance += diff

ุนูุฏ ุงูุฅูุบุงุก (โ๏ธ ููุทู ุญุฑุฌ):
  1. ูู ุงุฑุชุจุงุท ุงูู Allocations (ุชูุญุฐู)
     โ ูู allocation.delete() ูุฒูุฏ customer.balance ุจุงููุจูุบ
  2. customer.balance -= invoice.total
  3. invoice.balance = 0, invoice.paid_amount = 0
  
  ุงููุชูุฌุฉ ุงูุตุงููุฉ:
  customer.balance = original - total + paid = original - balance โ
```

---

## ๐ Validation Rules

### CreateInvoiceRequest

```php
[
    'customer_id' => 'required|exists:customers,id',
    'date' => 'required|date|before_or_equal:today',
    'items' => 'required|array|min:1',
    'items.*.product_id' => 'required|exists:products,id',
    'items.*.shipment_item_id' => 'required|exists:shipment_items,id',
    'items.*.quantity' => 'required|numeric|min:0.001',
    'items.*.unit_price' => 'required|numeric|min:0',
    'discount' => 'nullable|numeric|min:0',
    'type' => 'in:sale,wastage',
    'notes' => 'nullable|string|max:1000',
]
```

### UpdateInvoiceRequest

```php
[
    // ููุณ ููุงุนุฏ ุงูุฅูุดุงุก +
    'total' => [
        'required',
        'numeric',
        'min:0',
        // Custom Rule: ูุง ูููู ุฃู ูููู ุฃูู ูู ุงููุฏููุน
        function ($attribute, $value, $fail) {
            if ($value < $this->invoice->paid_amount) {
                $fail("ูุง ูููู ุชูููู ุงููููุฉ ุฃูู ูู ุงููุฏููุน");
            }
        },
    ],
]
```

---

## ๐ Authorization Rules (Policies)

### InvoicePolicy

```php
class InvoicePolicy
{
    /**
     * ูู ูููู ูููุณุชุฎุฏู ุนุฑุถ ุงููุงุชูุฑุฉุ
     */
    public function view(User $user, Invoice $invoice): bool
    {
        return $user->hasPermission('view_invoices');
    }
    
    /**
     * ูู ูููู ูููุณุชุฎุฏู ุฅูุดุงุก ูุงุชูุฑุฉุ
     */
    public function create(User $user): bool
    {
        return $user->hasPermission('create_invoices');
    }
    
    /**
     * ูู ูููู ูููุณุชุฎุฏู ุชุนุฏูู ุงููุงุชูุฑุฉุ
     * - ูุงูุฐุฉ ุงูุชุนุฏูู
     * - ุงููุงุชูุฑุฉ ูุดุทุฉ
     */
    public function update(User $user, Invoice $invoice): bool
    {
        if (!$user->hasPermission('edit_invoices')) {
            return false;
        }
        
        // ูุญุต ูุงูุฐุฉ ุงูุชุนุฏูู
        $editDays = (int) Setting::get('edit_window_days', 1);
        $cutoffDate = now()->subDays($editDays)->startOfDay();
        
        if ($invoice->date < $cutoffDate) {
            return false; // ุฎุงุฑุฌ ูุงูุฐุฉ ุงูุชุนุฏูู
        }
        
        // ูุญุต ุงูุญุงูุฉ
        return $invoice->status === 'active';
    }
    
    /**
     * ูู ูููู ูููุณุชุฎุฏู ุฅูุบุงุก ุงููุงุชูุฑุฉุ
     */
    public function cancel(User $user, Invoice $invoice): bool
    {
        return $user->hasPermission('cancel_invoices') 
            && $invoice->status === 'active';
    }
    
    // โ ูุง ููุฌุฏ delete() - ุงูุญุฐู ููููุน ููุงุฆูุงู
    // ุงุณุชุฎุฏู ุงูุฅูุบุงุก (cancel) ุจุฏูุงู ูู ุงูุญุฐู ููุญูุงุธ ุนูู ุณุฌู ุงููุฑุงุฌุนุฉ
}
```

---

## ๐ Observer Logic

### InvoiceObserver - ุงูุชูุตูู ุงููุงูู

```php
class InvoiceObserver
{
    /**
     * EVENT: created
     * TRIGGER: ุจุนุฏ ุญูุธ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ ูู DB
     */
    public function created(Invoice $invoice): void
    {
        DB::transaction(function () use ($invoice) {
            // 1. ุชุนููู balance = total
            $invoice->balance = $invoice->total;
            $invoice->saveQuietly();
            
            // 2. ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู
            $invoice->customer->increment('balance', $invoice->total);
            
            // 3. ุชุณุฌูู ูู Audit Log
            AuditLog::create([
                'model_type' => 'Invoice',
                'model_id' => $invoice->id,
                'action' => 'created',
                'new_values' => $invoice->toArray(),
                'user_id' => auth()->id(),
            ]);
        });
    }
    
    /**
     * EVENT: updated
     * SCENARIOS:
     * - ุชุบููุฑ total
     * - ุชุบููุฑ status (active โ cancelled)
     * - ุชุบููุฑ status (cancelled โ active)
     */
    public function updated(Invoice $invoice): void
    {
        DB::transaction(function () use ($invoice) {
            
            // ุงูุณููุงุฑูู 1: ุฅูุบุงุก ุงููุงุชูุฑุฉ โ๏ธ (ููุทู ุญุฑุฌ)
            if ($invoice->wasChanged('status')) {
                $oldStatus = $invoice->getOriginal('status');
                $newStatus = $invoice->status;
                
                if ($oldStatus === 'active' && $newStatus === 'cancelled') {
                    // โ๏ธ ุงูุฎุทูุฉ 1: ูู ุงุฑุชุจุงุท ุงูู Allocations ุฃููุงู
                    // ูุฐุง ุณููุฑุฌุน ุงููุจุงูุบ ุงููุฏููุนุฉ ูุฑุตูุฏ ุฏุงุฆู ููุนููู
                    $allocations = $invoice->allocations;
                    foreach ($allocations as $allocation) {
                        $allocation->delete(); // Observer ูุฒูุฏ customer.balance
                    }
                    
                    // โ๏ธ ุงูุฎุทูุฉ 2: ุชูููู ุฑุตูุฏ ุงูุนููู ุจุงูุฅุฌูุงูู
                    $invoice->customer->decrement('balance', $invoice->total);
                    
                    // โ๏ธ ุงูุฎุทูุฉ 3: ุชุตููุฑ ุงููุงุชูุฑุฉ
                    $invoice->balance = 0;
                    $invoice->paid_amount = 0;
                    $invoice->saveQuietly();
                    
                    return;
                }
                
                // ุงูุณููุงุฑูู 2: ุฅุนุงุฏุฉ ุชูุนูู ูุงุชูุฑุฉ ููุบุงุฉ
                // โ ููููุน ุงูุขู ูุฃู ุงูู allocations ูุญุฐููุฉ
                if ($oldStatus === 'cancelled' && $newStatus === 'active') {
                    throw new \Exception('ูุง ูููู ุฅุนุงุฏุฉ ุชูุนูู ูุงุชูุฑุฉ ููุบุงุฉ');
                }
            }
            
            // ุงูุณููุงุฑูู 3: ุชุบููุฑ ูููุฉ ุงููุงุชูุฑุฉ
            if ($invoice->wasChanged('total')) {
                $oldTotal = $invoice->getOriginal('total');
                $newTotal = $invoice->total;
                
                // ูุญุต ุงูุณูุงูุฉ
                if ($newTotal < $invoice->paid_amount) {
                    throw new \Exception("ูุง ูููู ุชูููู ุงููููุฉ ุฃูู ูู ุงููุฏููุน");
                }
                
                $diff = $newTotal - $oldTotal;
                $invoice->balance = $newTotal - $invoice->paid_amount;
                $invoice->saveQuietly();
                
                if ($diff > 0) {
                    $invoice->customer->increment('balance', $diff);
                } else {
                    $invoice->customer->decrement('balance', abs($diff));
                }
            }
        });
    }
    
    /**
     * EVENT: deleting
     * PURPOSE: โ ููุน ุงูุญุฐู ููุงุฆูุงู - ุงุณุชุฎุฏู ุงูุฅูุบุงุก ุจุฏูุงู ูู ุฐูู
     * ุชุตุญูุญ: 2025-12-13
     */
    public function deleting(Invoice $invoice): bool
    {
        throw new \Exception(
            "ูุง ูููู ุญุฐู ุงูููุงุชูุฑ. ุงุณุชุฎุฏู ุงูุฅูุบุงุก ุจุฏูุงู ูู ุงูุญุฐู ููุญูุงุธ ุนูู ุณุฌู ุงููุฑุงุฌุนุฉ."
        );
    }
}
```

---

## ๐ Flowchart: ุฅูุดุงุก ูุงุชูุฑุฉ

```
โโโโโโโโโโโโโโโ
โ   ุงูุจุฏุงูุฉ   โ
โโโโโโโโฌโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุฅูุดุงุก โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
            โ
    โโโโโโโโโดโโโโโโโโ
    โ               โ
   โ              โ
    โ               โ
    โผ               โผ
โโโโโโโโโโโ    โโโโโโโโโโโโ
โ ุงููุชุงุจุนุฉ โ    โ 403 Errorโ
โโโโโโฌโโโโโ    โโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Validation Request    โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
            โ
    โโโโโโโโโดโโโโโโโโ
    โ               โ
   โ              โ
    โ               โ
    โผ               โผ
โโโโโโโโโโโ    โโโโโโโโโโโโ
โ ุงููุชุงุจุนุฉ โ    โ 422 Errorโ
โโโโโโฌโโโโโ    โโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  FIFO Allocation Check  โ
โ  ูุญุต ุชููุฑ ุงููููุงุช       โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
            โ
    โโโโโโโโโดโโโโโโโโ
    โ               โ
   โ              โ
    โ               โ
    โผ               โผ
โโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ
โ ุงููุชุงุจุนุฉ โ    โ "ุงููููุฉ ุบูุฑ ูุชููุฑุฉ"โ
โโโโโโฌโโโโโ    โโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ DB::transaction START   โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ุฅูุดุงุก Invoice         โ
โ   - ุชูููุฏ invoice_numberโ
โ   - ุญุณุงุจ total          โ
โ   - balance = total     โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ุฅูุดุงุก InvoiceItems    โ
โ   - ุฑุจุท ุจู shipment_itemโ
โ   - ุฎุตู remaining_qty   โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ InvoiceObserver::createdโ
โ - customer.balance +=   โ
โ - AuditLog              โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ DB::transaction COMMIT  โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Return Invoice JSON   โ
โ   201 Created           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โ๏ธ Edge Cases

### 1. ูุงุชูุฑุฉ ุจุฎุตู ุฃูุจุฑ ูู ุงูุฅุฌูุงูู

```
ุงููุดููุฉ: discount > subtotal
ุงููุชูุฌุฉ: total ุณุงูุจ

ุงูุญู: Validation
'discount' => 'lte:subtotal'
```

### 2. ุชุนุฏูู ูุงุชูุฑุฉ ูุณุฏุฏุฉ ุฌุฒุฆูุงู

```
ุงูุญุงูุฉ: total = 1000, paid = 500

ูุญุงููุฉ: ุชุนุฏูู total ุฅูู 400
ุงููุดููุฉ: 400 < 500

ุงูุญู: 
if ($newTotal < $invoice->paid_amount) {
    throw Exception;
}
```

### 3. ุฅูุบุงุก ูุงุชูุฑุฉ ูุณุฏุฏุฉ ุฌุฒุฆูุงู โ๏ธ

```
ุงูุญุงูุฉ: total = 1000, paid = 500, balance = 500

ุงูุฅุฌุฑุงุก: status โ cancelled

ุงูุฎุทูุงุช:
1. ุญุฐู allocations โ customer.balance += 500 (ุฑุตูุฏ ุฏุงุฆู)
2. customer.balance -= 1000 (ุฅุฌูุงูู ุงููุงุชูุฑุฉ)
3. invoice.balance = 0, invoice.paid_amount = 0

ุงููุชูุฌุฉ ุงูุตุงููุฉ:
- customer.balance ุชูู ุจู 500 (= balance ุงูุฃุตูู) โ
- ุงูุชุญุตููุงุช ุชุตุจุญ ุบูุฑ ููุฒุนุฉ (ุฑุตูุฏ ุฏุงุฆู ููุนููู)
- ูุง ููุฌุฏ ุชูุงูุถ ููุทูู
```

### 4. ุงูุฅูุบุงุก ููุท (ูุง ููุฌุฏ ุญุฐู) โ๏ธ ุชุตุญูุญ 2025-12-13

> **ูุฑุงุฑ ุชุตููู:** ุงูุญุฐู ููููุน ููุงุฆูุงู. ููุณุชุฎุฏู ุงูุฅูุบุงุก ููุท.

```
ุงูุฅูุบุงุก:
- ูุจูู ุงูุณุฌู ููุชุงุฑูุฎ (Audit Trail)
- ูุณููุญ ุญุชู ูู ูุฏููุน ุฌุฒุฆูุงู
- ููุฑุฌุน ุงููุฏููุนุงุช ูุฑุตูุฏ ุฏุงุฆู ููุนููู
- ููุนูุฏ ุงููููุงุช ูููุฎุฒูู

ุงูุญุฐู:
โ ููููุน ููุงุฆูุงู
โ ููููู Exception ูู Observer
```

---

## ๐ Performance Considerations

### Indexes ุงููุทููุจุฉ

```sql
INDEX idx_customer (customer_id)     -- ููุจุญุซ ุจุงูุนููู
INDEX idx_date (date)                -- ููุชูุงุฑูุฑ ุงูููููุฉ
INDEX idx_balance (balance)          -- ููููุงุชูุฑ ุบูุฑ ุงููุณุฏุฏุฉ
INDEX idx_status (status)            -- ููููุชุฑุฉ
INDEX idx_number (invoice_number)    -- ููุจุญุซ ุจุงูุฑูู
```

### N+1 Prevention

```php
// โ ุฎุทุฃ
$invoices = Invoice::all();
foreach ($invoices as $invoice) {
    echo $invoice->customer->name; // N+1
}

// โ ุตุญูุญ
$invoices = Invoice::with('customer', 'items.product')->get();
```

---

## ๐ ุงูููุงุนุฏ ุงููุฑุชุจุทุฉ

- BR-INV-001 ุฅูู BR-INV-007
- BR-COL-004 (ุชุญุฏูุซ ุงููุงุชูุฑุฉ ุนูุฏ ุงูุชุญุตูู)
- BR-FIFO-002 (ุชุชุจุน ูุตุฏุฑ ุงููุฎุฒูู)

---

## ๐ ุณุฌู ุงูุชุบููุฑุงุช (Change Log)

| ุงูุชุงุฑูุฎ | ุงูุชุนุฏูู | ุงูุณุจุจ |
|---------|---------|-------|
| 2025-12-13 | ุชุตุญูุญ ุญุณุงุจ ุงูุฅุฌูุงูู: `total_weight_kg ร price_per_kg` | ูุงู ุฎุงุทุฆุงู: `quantity ร unit_price` |
| 2025-12-13 | ุฅุถุงูุฉ ุฃูุถุงุน ุฅุฏุฎุงู ุงููุฒู (total_weight / unit_weight) | ุชูุถูุญ ููุทู ุงูุฅุฏุฎุงู |
| 2025-12-13 | ุฅุฒุงูุฉ ููุทู ุงูุญุฐู - ุงูุฅูุบุงุก ููุท | ูุฑุงุฑ ุชุตููู: ุงูุญูุงุธ ุนูู Audit Trail |
| 2025-12-13 | ุฅุถุงูุฉ ุนุฌุฒ ุงูููููุงุช ูู ุจูุงู ุงูุชุตููุฉ | ุชูุถูุญ ุชูุฑูุฑ ุงูุดุญูุฉ |
